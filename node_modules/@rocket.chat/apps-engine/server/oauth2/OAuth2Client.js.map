{"version":3,"sources":["src/server/oauth2/OAuth2Client.ts"],"names":[],"mappings":"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","file":"OAuth2Client.js","sourcesContent":["import { URL } from 'url';\nimport {\n    HttpStatusCode,\n    IConfigurationExtend,\n    IHttp,\n    IModify,\n    IPersistence,\n    IRead,\n} from '../../definition/accessors';\nimport {\n    ApiSecurity,\n    ApiVisibility,\n    IApiEndpointInfo,\n    IApiRequest,\n    IApiResponse,\n} from '../../definition/api';\nimport { App } from '../../definition/App';\nimport { RocketChatAssociationModel, RocketChatAssociationRecord } from '../../definition/metadata';\nimport { IAuthData, IOAuth2Client, IOAuth2ClientOptions } from '../../definition/oauth2/IOAuth2';\nimport { SettingType } from '../../definition/settings';\nimport { IUser } from '../../definition/users';\n\nexport enum GrantType {\n    RefreshToken =  'refresh_token',\n    AuthorizationCode =  'authorization_code',\n}\n\nexport class OAuth2Client implements IOAuth2Client {\n\n    private defaultContents = {\n        success:  '<div style=\"display: flex;align-items: center;justify-content: center; height: 100%;\">\\\n                        <h1 style=\"text-align: center; font-family: Helvetica Neue;\">\\\n                            Authorization went successfully<br>\\\n                            You can close this tab now<br>\\\n                        </h1>\\\n                    </div>',\n        failed: '<div style=\"display: flex;align-items: center;justify-content: center; height: 100%;\">\\\n                    <h1 style=\"text-align: center; font-family: Helvetica Neue;\">\\\n                        Oops, something went wrong, please try again or in case it still does not work, contact the administrator.\\\n                    </h1>\\\n                </div>',\n    };\n\n    constructor(\n        private readonly app: App,\n        private readonly config: IOAuth2ClientOptions,\n    ) {}\n\n    public async setup(configuration: IConfigurationExtend): Promise<void> {\n        configuration.api.provideApi({\n            security: ApiSecurity.UNSECURE,\n            visibility: ApiVisibility.PUBLIC,\n            endpoints: [\n                {\n                    path: `${this.config.alias}-callback`,\n                    get: this.handleOAuthCallback.bind(this),\n                },\n            ],\n        });\n\n        await Promise.all([\n            configuration.settings.provideSetting({\n                id: `${this.config.alias}-oauth-client-id`,\n                type: SettingType.STRING,\n                public: true,\n                required: true,\n                packageValue: '',\n                i18nLabel: `${this.config.alias}-oauth-client-id`,\n            }),\n\n            configuration.settings.provideSetting({\n                id: `${this.config.alias}-oauth-clientsecret`,\n                type: SettingType.STRING,\n                public: true,\n                required: true,\n                packageValue: '',\n                i18nLabel: `${this.config.alias}-oauth-client-secret`,\n            }),\n        ]);\n    }\n\n    public async getUserAuthorizationUrl(user: IUser, scopes?: Array<string>): Promise<URL> {\n        const redirectUri = this.app\n            .getAccessors()\n            .providedApiEndpoints[0].computedPath.substring(1);\n\n        const siteUrl = await this.getBaseURLWithoutTrailingSlash();\n\n        const finalScopes = ([] as Array<string>).concat(\n            this.config.defaultScopes || [],\n            scopes || [],\n        );\n\n        const authUri = this.config.authUri;\n\n        const clientId = await this.app\n            .getAccessors()\n            .reader.getEnvironmentReader()\n            .getSettings()\n            .getValueById(`${this.config.alias}-oauth-client-id`);\n\n        const url = new URL(authUri, siteUrl);\n\n        url.searchParams.set('response_type', 'code');\n        url.searchParams.set('redirect_uri', `${siteUrl}/${redirectUri}`);\n        url.searchParams.set('state', user.id);\n        url.searchParams.set('client_id', clientId);\n        url.searchParams.set('access_type', 'offline');\n\n        if (finalScopes.length > 0) {\n            url.searchParams.set('scope', finalScopes.join(' '));\n        }\n\n        return url;\n    }\n\n    public async getAccessTokenForUser(user: IUser): Promise<IAuthData | undefined> {\n        const associations = [\n            new RocketChatAssociationRecord(\n                RocketChatAssociationModel.USER,\n                user.id,\n            ),\n            new RocketChatAssociationRecord(\n                RocketChatAssociationModel.MISC,\n                `${this.config.alias}-oauth-connection`,\n            ),\n        ];\n\n        const [ result ] = await this.app\n            .getAccessors()\n            .reader.getPersistenceReader()\n            .readByAssociations(associations) as unknown as Array<IAuthData | undefined>;\n\n        return result;\n    }\n\n    public async refreshUserAccessToken(user: IUser, persis: IPersistence): Promise<IAuthData | undefined> {\n        try {\n            const tokenInfo = await this.getAccessTokenForUser(user);\n\n            if (!tokenInfo) {\n                throw new Error('User has no access token information');\n            }\n\n            if (!tokenInfo.refreshToken) {\n                throw new Error('User token information has no refresh token available');\n            }\n\n            const {\n                config: { refreshTokenUri },\n            } = this;\n\n            const clientId = await this.app\n                .getAccessors()\n                .reader.getEnvironmentReader()\n                .getSettings()\n                .getValueById(`${this.config.alias}-oauth-client-id`);\n\n            const clientSecret = await this.app\n                .getAccessors()\n                .reader.getEnvironmentReader()\n                .getSettings()\n                .getValueById(`${this.config.alias}-oauth-clientsecret`);\n\n            const siteUrl = await this.getBaseURLWithoutTrailingSlash();\n\n            const redirectUri = this.app\n                    .getAccessors()\n                    .providedApiEndpoints[0].computedPath.substring(1);\n\n            const url = new URL(refreshTokenUri);\n\n            url.searchParams.set('client_id', clientId);\n            url.searchParams.set('client_secret', clientSecret);\n            url.searchParams.set('redirect_uri', `${siteUrl}/${redirectUri}`);\n            url.searchParams.set('refresh_token', tokenInfo.refreshToken);\n            url.searchParams.set('grant_type', GrantType.RefreshToken);\n\n            const { content, statusCode } = await this.app.getAccessors().http.post(url.href);\n\n            if (statusCode !== 200) {\n                throw new Error('Request to provider was unsuccessful. Check logs for more information');\n            }\n\n            const { access_token, expires_in, refresh_token, scope } = JSON.parse(\n                content as string,\n            );\n\n            if (!access_token) {\n                throw new Error('No access token returned by the provider');\n            }\n\n            const authData: IAuthData = {\n                scope,\n                token: access_token,\n                expiresAt: expires_in,\n                refreshToken: refresh_token || tokenInfo.refreshToken,\n            };\n\n            await this.saveToken(authData, user.id, persis);\n\n            return authData;\n        } catch (error) {\n            this.app.getLogger().error(error);\n            throw error;\n        }\n    }\n\n    public async revokeUserAccessToken(user: IUser, persis: IPersistence): Promise<boolean> {\n        try {\n            const tokenInfo = await this.getAccessTokenForUser(user);\n\n            if (!tokenInfo?.token) {\n                throw new Error('No access token available for this user.');\n            }\n\n            const url = new URL(this.config.revokeTokenUri);\n\n            url.searchParams.set('token', tokenInfo?.token);\n\n            const result = await this.app.getAccessors().http.post(url.href);\n\n            if (result.statusCode !== 200) {\n                throw new Error('Provider did not allow token to be revoked');\n            }\n\n            await this.removeToken({ userId: user.id, persis });\n\n            return true;\n        } catch (error) {\n            this.app.getLogger().error(error);\n            return false;\n        }\n    }\n\n    private async getBaseURLWithoutTrailingSlash(): Promise<string> {\n        const SITE_URL = 'Site_Url';\n        const url = await this.app\n            .getAccessors()\n            .environmentReader.getServerSettings()\n            .getValueById(SITE_URL);\n\n        if (url.endsWith('/')) {\n            return url.substr(0, url.length - 1);\n        }\n        return url;\n    }\n\n    private async handleOAuthCallback(\n        request: IApiRequest,\n        endpoint: IApiEndpointInfo,\n        read: IRead,\n        modify: IModify,\n        http: IHttp,\n        persis: IPersistence,\n    ): Promise<IApiResponse> {\n        try {\n            const {\n                query: { code, state },\n            } = request;\n\n            const user = await this.app\n                .getAccessors()\n                .reader\n                .getUserReader()\n                .getById(state);\n\n            if (!user) {\n                throw new Error('User could not be determined.');\n            }\n\n            // User chose not to authorize the access\n            if (!code) {\n                const failedResult = await this.config.authorizationCallback?.(\n                    undefined,\n                    user,\n                    read,\n                    modify,\n                    http,\n                    persis,\n                );\n\n                return {\n                    status: HttpStatusCode.UNAUTHORIZED,\n                    content: failedResult?.responseContent || this.defaultContents.failed,\n                };\n            }\n\n            const siteUrl = await this.getBaseURLWithoutTrailingSlash();\n\n            const accessTokenUrl = this.config.accessTokenUri;\n\n            const redirectUri = this.app\n                .getAccessors()\n                .providedApiEndpoints[0].computedPath.substring(1);\n\n            const clientId = await this.app\n                .getAccessors()\n                .reader.getEnvironmentReader()\n                .getSettings()\n                .getValueById(`${this.config.alias}-oauth-client-id`);\n\n            const clientSecret = await this.app\n                .getAccessors()\n                .reader.getEnvironmentReader()\n                .getSettings()\n                .getValueById(`${this.config.alias}-oauth-clientsecret`);\n\n            const url = new URL(accessTokenUrl, siteUrl);\n\n            url.searchParams.set('client_id', clientId);\n            url.searchParams.set('redirect_uri', `${siteUrl}/${redirectUri}`);\n            url.searchParams.set('code', code);\n            url.searchParams.set('client_secret', clientSecret);\n            url.searchParams.set('access_type', 'offline');\n            url.searchParams.set('grant_type', GrantType.AuthorizationCode);\n\n            const { content, statusCode } = await http.post(url.href, {\n                headers: { Accept: 'application/json' },\n            });\n\n            // If provider had a server error, nothing we can do\n            if (statusCode >= 500) {\n                throw new Error('Request for access token failed. Check logs for more information');\n            }\n\n            const response = JSON.parse(content as string);\n            const { access_token, expires_in, refresh_token, scope } = response;\n\n            const authData: IAuthData = {\n                scope,\n                token: access_token,\n                expiresAt: expires_in,\n                refreshToken: refresh_token,\n            };\n\n            const result = await this.config.authorizationCallback?.(\n                authData,\n                user,\n                read,\n                modify,\n                http,\n                persis,\n            );\n\n            await this.saveToken(\n                authData,\n                user.id,\n                persis,\n            );\n\n            return {\n                status: statusCode,\n                content: result?.responseContent || this.defaultContents.success,\n            };\n        } catch (error) {\n            this.app.getLogger().error(error);\n            return {\n                status: HttpStatusCode.INTERNAL_SERVER_ERROR,\n                content: this.defaultContents.failed,\n            };\n        }\n    }\n\n    private async saveToken(authData: IAuthData, userId: string, persis: IPersistence): Promise<string> {\n        const { scope, token, expiresAt, refreshToken } = authData;\n\n        return persis.updateByAssociations(\n            [\n                new RocketChatAssociationRecord(\n                    RocketChatAssociationModel.USER,\n                    userId,\n                ),\n                new RocketChatAssociationRecord(\n                    RocketChatAssociationModel.MISC,\n                    `${this.config.alias}-oauth-connection`,\n                ),\n            ],\n            {\n                scope,\n                token,\n                expiresAt: expiresAt || '',\n                refreshToken: refreshToken || '',\n            },\n            true, // we want to create the record if it doesn't exist\n        );\n    }\n\n    private async removeToken({\n        userId,\n        persis,\n    }: {\n        userId: string,\n        persis: IPersistence,\n    }): Promise<IAuthData> {\n        const [ result ] = await persis.removeByAssociations([\n            new RocketChatAssociationRecord(\n                RocketChatAssociationModel.USER,\n                userId,\n            ),\n            new RocketChatAssociationRecord(\n                RocketChatAssociationModel.MISC,\n                `${this.config.alias}-oauth-connection`,\n            ),\n        ]) as unknown as Array<IAuthData>;\n\n        return result;\n    }\n}\n"]}