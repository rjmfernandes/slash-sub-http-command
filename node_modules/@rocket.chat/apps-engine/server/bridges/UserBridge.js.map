{"version":3,"sources":["src/server/bridges/UserBridge.ts"],"names":[],"mappings":";;;;;;;;;;;;AACA,2EAAwE;AACxE,2EAAwE;AACxE,kEAA+D;AAC/D,6CAA0C;AAE1C,MAAsB,UAAW,SAAQ,uBAAU;IAClC,SAAS,CAAC,EAAU,EAAE,KAAa;;YAC5C,IAAI,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,EAAE;gBAC/B,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC;aAClC;QACL,CAAC;KAAA;IAEY,eAAe,CAAC,QAAgB,EAAE,KAAa;;YACxD,IAAI,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,EAAE;gBAC/B,OAAO,IAAI,CAAC,aAAa,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;aAC9C;QACL,CAAC;KAAA;IAEY,YAAY,CAAC,KAAc;;YACpC,OAAO,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;QAClC,CAAC;KAAA;IAEY,QAAQ,CAAC,IAAoB,EAAE,KAAa,EAAE,OAA8B;;YACrF,IAAI,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,EAAE;gBAChC,OAAO,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,KAAK,EAAE,OAAO,IAAI,EAAE,CAAC,CAAC;aAClD;QACL,CAAC;KAAA;IAEY,QAAQ,CAAC,IAAW,EAAE,KAAa;;YAC5C,IAAI,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,EAAE;gBAChC,OAAO,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;aACnC;QACL,CAAC;KAAA;IAEY,QAAQ,CAAC,IAAW,EAAE,OAAuB,EAAE,KAAa;;YACrE,IAAI,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,EAAE;gBAChC,OAAO,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,OAAO,EAAE,KAAK,CAAC,CAAC;aAC5C;QACL,CAAC;KAAA;IAEY,2BAA2B,CAAC,GAAW,EAAE,KAAa;;YAC/D,IAAI,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,EAAE;gBAC/B,OAAO,IAAI,CAAC,yBAAyB,CAAC,GAAG,CAAC,CAAC;aAC9C;QACL,CAAC;KAAA;IAoCO,iBAAiB,CAAC,KAAa;QACnC,IAAI,2CAAoB,CAAC,aAAa,CAAC,KAAK,EAAE,+BAAc,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;YACrE,OAAO,IAAI,CAAC;SACf;QAED,2CAAoB,CAAC,gBAAgB,CAAC,IAAI,6CAAqB,CAAC;YAC5D,KAAK;YACL,kBAAkB,EAAE,CAAC,+BAAc,CAAC,IAAI,CAAC,IAAI,CAAC;SACjD,CAAC,CAAC,CAAC;QAEJ,OAAO,KAAK,CAAC;IACjB,CAAC;IAEO,kBAAkB,CAAC,KAAa;QACpC,IAAI,2CAAoB,CAAC,aAAa,CAAC,KAAK,EAAE,+BAAc,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;YACtE,OAAO,IAAI,CAAC;SACf;QAED,2CAAoB,CAAC,gBAAgB,CAAC,IAAI,6CAAqB,CAAC;YAC5D,KAAK;YACL,kBAAkB,EAAE,CAAC,+BAAc,CAAC,IAAI,CAAC,KAAK,CAAC;SAClD,CAAC,CAAC,CAAC;QAEJ,OAAO,KAAK,CAAC;IACjB,CAAC;CACJ;AApGD,gCAoGC","file":"UserBridge.js","sourcesContent":["import { IUser, IUserCreationOptions } from '../../definition/users';\nimport { PermissionDeniedError } from '../errors/PermissionDeniedError';\nimport { AppPermissionManager } from '../managers/AppPermissionManager';\nimport { AppPermissions } from '../permissions/AppPermissions';\nimport { BaseBridge } from './BaseBridge';\n\nexport abstract class UserBridge extends BaseBridge {\n    public async doGetById(id: string, appId: string): Promise<IUser> {\n        if (this.hasReadPermission(appId)) {\n            return this.getById(id, appId);\n        }\n    }\n\n    public async doGetByUsername(username: string, appId: string): Promise<IUser> {\n        if (this.hasReadPermission(appId)) {\n            return this.getByUsername(username, appId);\n        }\n    }\n\n    public async doGetAppUser(appId?: string): Promise<IUser | undefined> {\n        return this.getAppUser(appId);\n    }\n\n    public async doCreate(data: Partial<IUser>, appId: string, options?: IUserCreationOptions): Promise<string> {\n        if (this.hasWritePermission(appId)) {\n            return this.create(data, appId, options || {});\n        }\n    }\n\n    public async doRemove(user: IUser, appId: string): Promise<boolean> {\n        if (this.hasWritePermission(appId)) {\n            return this.remove(user, appId);\n        }\n    }\n\n    public async doUpdate(user: IUser, updates: Partial<IUser>, appId: string): Promise<boolean> {\n        if (this.hasWritePermission(appId)) {\n            return this.update(user, updates, appId);\n        }\n    }\n\n    public async doGetUserUnreadMessageCount(uid: string, appId: string): Promise<number> {\n        if (this.hasReadPermission(appId)) {\n            return this.getUserUnreadMessageCount(uid);\n        }\n    }\n\n    protected abstract getById(id: string, appId: string): Promise<IUser>;\n    protected abstract getByUsername(username: string, appId: string): Promise<IUser>;\n    protected abstract getAppUser(appId?: string): Promise<IUser | undefined>;\n    protected abstract getActiveUserCount(): Promise<number>;\n\n    protected abstract getUserUnreadMessageCount(uid: string): Promise<number>;\n    /**\n     * Creates a user.\n     * @param data the essential data for creating a user\n     * @param appId the id of the app calling this\n     * @param options options for passing extra data\n     */\n    protected abstract create(data: Partial<IUser>, appId: string, options?: IUserCreationOptions): Promise<string>;\n    /**\n     * Remove a user.\n     *\n     * @param user the user object to be removed\n     * @param appId the id of the app executing the call\n     */\n    protected abstract remove(user: IUser, appId: string): Promise<boolean>;\n    /**\n     * Updates a user.\n     *\n     * Note: the actual methods used by apps to update\n     * user properties are much more granular, but at a\n     * bridge level we can adopt a more practical approach\n     * since it is only accessible internally by the framework\n     *\n     * @param user the user to be updated\n     * @param updates a map of properties to be updated\n     * @param appId the id of the app executing the call\n     */\n    protected abstract update(user: IUser, updates: Partial<IUser>, appId: string): Promise<boolean>;\n\n    private hasReadPermission(appId: string): boolean {\n        if (AppPermissionManager.hasPermission(appId, AppPermissions.user.read)) {\n            return true;\n        }\n\n        AppPermissionManager.notifyAboutError(new PermissionDeniedError({\n            appId,\n            missingPermissions: [AppPermissions.user.read],\n        }));\n\n        return false;\n    }\n\n    private hasWritePermission(appId: string): boolean {\n        if (AppPermissionManager.hasPermission(appId, AppPermissions.user.write)) {\n            return true;\n        }\n\n        AppPermissionManager.notifyAboutError(new PermissionDeniedError({\n            appId,\n            missingPermissions: [AppPermissions.user.write],\n        }));\n\n        return false;\n    }\n}\n"]}