{"version":3,"sources":["src/server/managers/AppVideoConfProvider.ts"],"names":[],"mappings":"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","file":"AppVideoConfProvider.js","sourcesContent":["import { AppMethod } from '../../definition/metadata';\nimport { IBlock } from '../../definition/uikit';\nimport { VideoConference } from '../../definition/videoConferences';\nimport { IVideoConferenceUser } from '../../definition/videoConferences/IVideoConferenceUser';\nimport type { IVideoConferenceOptions, IVideoConfProvider, VideoConfData, VideoConfDataExtended } from '../../definition/videoConfProviders';\n\nimport { ProxiedApp } from '../ProxiedApp';\nimport { AppLogStorage } from '../storage';\nimport { AppAccessorManager } from './AppAccessorManager';\n\nexport class AppVideoConfProvider {\n    /**\n     * States whether this provider has been registered into the Rocket.Chat system or not.\n     */\n    public isRegistered: boolean;\n\n    constructor(public app: ProxiedApp, public provider: IVideoConfProvider) {\n        this.isRegistered = false;\n    }\n\n    public hasBeenRegistered(): void {\n        this.isRegistered = true;\n    }\n\n    public canBeRan(method: AppMethod): boolean {\n        return this.app.hasMethod(method);\n    }\n\n    public async runIsFullyConfigured(\n      logStorage: AppLogStorage,\n      accessors: AppAccessorManager,\n    ): Promise<boolean> {\n        if (typeof this.provider[AppMethod._VIDEOCONF_IS_CONFIGURED] !== 'function') {\n            return true;\n        }\n\n        return !!await this.runTheCode(AppMethod._VIDEOCONF_IS_CONFIGURED, logStorage, accessors, []) as boolean;\n    }\n\n    public async runGenerateUrl(\n      call: VideoConfData,\n      logStorage: AppLogStorage,\n      accessors: AppAccessorManager,\n    ): Promise<string> {\n        return await this.runTheCode(AppMethod._VIDEOCONF_GENERATE_URL, logStorage, accessors, [call]) as string;\n    }\n\n    public async runCustomizeUrl(\n      call: VideoConfDataExtended,\n      user: IVideoConferenceUser | undefined,\n      options: IVideoConferenceOptions = {},\n      logStorage: AppLogStorage,\n      accessors: AppAccessorManager,\n    ): Promise<string> {\n        return await this.runTheCode(AppMethod._VIDEOCONF_CUSTOMIZE_URL, logStorage, accessors, [call, user, options]) as string;\n    }\n\n    public async runOnNewVideoConference(\n      call: VideoConference,\n      logStorage: AppLogStorage,\n      accessors: AppAccessorManager,\n    ): Promise<void> {\n        await this.runTheCode(AppMethod._VIDEOCONF_NEW, logStorage, accessors, [call]);\n    }\n\n    public async runOnVideoConferenceChanged(\n      call: VideoConference,\n      logStorage: AppLogStorage,\n      accessors: AppAccessorManager,\n    ): Promise<void> {\n        await this.runTheCode(AppMethod._VIDEOCONF_CHANGED, logStorage, accessors, [call]);\n    }\n\n    public async runOnUserJoin(\n      call: VideoConference,\n      user: IVideoConferenceUser | undefined,\n      logStorage: AppLogStorage,\n      accessors: AppAccessorManager,\n    ): Promise<void> {\n        await this.runTheCode(AppMethod._VIDEOCONF_USER_JOINED, logStorage, accessors, [call, user]);\n    }\n\n    public async runGetVideoConferenceInfo(\n      call: VideoConference,\n      user: IVideoConferenceUser | undefined,\n      logStorage: AppLogStorage,\n      accessors: AppAccessorManager,\n    ): Promise<Array<IBlock> | undefined> {\n        return await this.runTheCode(AppMethod._VIDEOCONF_GET_INFO, logStorage, accessors, [call, user]) as Array<IBlock> | undefined;\n    }\n\n    private async runTheCode(\n      method: AppMethod._VIDEOCONF_GENERATE_URL | AppMethod._VIDEOCONF_CUSTOMIZE_URL | AppMethod._VIDEOCONF_IS_CONFIGURED |\n      AppMethod._VIDEOCONF_NEW | AppMethod._VIDEOCONF_CHANGED | AppMethod._VIDEOCONF_GET_INFO | AppMethod._VIDEOCONF_USER_JOINED,\n      logStorage: AppLogStorage,\n      accessors: AppAccessorManager,\n      runContextArgs: Array<any>,\n    ): Promise<string | boolean | Array<IBlock> | undefined> {\n        // Ensure the provider has the property before going on\n        if (typeof this.provider[method] !== 'function') {\n            return;\n        }\n\n        const runContext = {\n            provider: this.provider,\n            args: [\n                ...runContextArgs,\n                accessors.getReader(this.app.getID()),\n                accessors.getModifier(this.app.getID()),\n                accessors.getHttp(this.app.getID()),\n                accessors.getPersistence(this.app.getID()),\n            ],\n        };\n\n        const logger = this.app.setupLogger(method);\n        logger.debug(`Executing ${ method } on video conference provider...`);\n\n        let result: string | undefined;\n        try {\n            const runCode = `module.exports = provider.${ method }.apply(provider, args)`;\n            result = await this.app.getRuntime().runInSandbox(runCode, runContext);\n            logger.debug(`Video Conference Provider's ${ method } was successfully executed.`);\n        } catch (e) {\n            logger.error(e);\n            logger.debug(`Video Conference Provider's ${ method } was unsuccessful.`);\n        }\n\n        try {\n            await logStorage.storeEntries(this.app.getID(), logger);\n        } catch (e) {\n            // Don't care, at the moment.\n            // TODO: Evaluate to determine if we do care\n        }\n\n        return result;\n    }\n}\n"]}